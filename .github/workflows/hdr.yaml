name: HDR Image Processing (fixed)

on:
    pull_request:
        branches:
            - "**"

env:
    GO_VERSION: "1.21"
    INPUT_DIR: "examples/input"
    OUTPUT_DIR: "examples/output"
    OUTPUT_FILE: "hdr_result.jpg"
    TEST_IMAGE_LOW: "https://www.easyhdr.com/examples/pond/pond1.jpg"
    TEST_IMAGE_MID: "https://www.easyhdr.com/examples/pond/pond3.jpg"
    TEST_IMAGE_HIGH: "https://www.easyhdr.com/examples/pond/pond2.jpg"

jobs:
    process-hdr:
        runs-on: ubuntu-latest
        timeout-minutes: 10

        permissions:
            contents: read
            pull-requests: write
            actions: write # Needed for artifact upload

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Set up Go
              id: go-setup
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}
                  check-latest: true
                  cache: true

            - name: Verify Go installation
              run: |
                  go version
                  if [ $? -ne 0 ]; then
                    echo "::error::Go installation failed"
                    exit 1
                  fi

            - name: Run tests
              id: tests
              run: |
                  go test -v -race -timeout 5m ./...
              continue-on-error: false

            - name: Setup directories
              id: setup-dirs
              run: |
                  mkdir -p "${{ env.INPUT_DIR }}" "${{ env.OUTPUT_DIR }}"
                  if [ ! -d "${{ env.INPUT_DIR }}" ] || [ ! -d "${{ env.OUTPUT_DIR }}" ]; then
                    echo "::error::Failed to create required directories"
                    exit 1
                  fi

            - name: Download test images
              id: download-images
              run: |
                  download_image() {
                    local exposure=$1
                    local url=$2
                    local output="${{ env.INPUT_DIR }}/${exposure}.jpg"
                    
                    echo "Downloading ${exposure} exposure image..."
                    if ! curl -sSL --retry 3 --retry-delay 2 -f -o "$output" "$url"; then
                      echo "::error::Failed to download ${exposure} exposure image from ${url}"
                      return 1
                    fi
                    
                    if ! file "$output" | grep -qi "JPEG image data"; then
                      echo "::error::Downloaded file is not a valid JPEG: ${output}"
                      return 1
                    fi
                    
                    echo "Successfully downloaded and verified ${exposure} exposure image"
                    return 0
                  }

                  download_image "low" "${{ env.TEST_IMAGE_LOW }}" &
                  pid1=$!
                  download_image "mid" "${{ env.TEST_IMAGE_MID }}" &
                  pid2=$!
                  download_image "high" "${{ env.TEST_IMAGE_HIGH }}" &
                  pid3=$!

                  for pid in $pid1 $pid2 $pid3; do
                    if ! wait "$pid"; then
                      echo "::error::One or more image downloads failed"
                      exit 1
                    fi
                  done

            - name: Install ImageMagick
              run: |
                  sudo apt-get update
                  sudo apt-get install -y imagemagick

            - name: Process HDR image
              id: process-hdr
              run: |
                  echo "Starting HDR processing..."

                  timeout 300s go run ./cmd/hdarrrr/main.go \
                    -low "${{ env.INPUT_DIR }}/low.jpg" \
                    -mid "${{ env.INPUT_DIR }}/mid.jpg" \
                    -high "${{ env.INPUT_DIR }}/high.jpg" \
                    -output "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}"

                  if [ $? -ne 0 ]; then
                    echo "::error::HDR processing failed or timed out"
                    exit 1
                  fi

                  output_file="${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}"
                  if [ ! -f "$output_file" ]; then
                    echo "::error::Output file was not created: $output_file"
                    exit 1
                  fi

                  if ! file "$output_file" | grep -qi "JPEG image data"; then
                    echo "::error::Output is not a valid JPEG file"
                    exit 1
                  fi

                  # Create preview version
                  convert "$output_file" -quality 60 -resize "800x800>" "${{ env.OUTPUT_DIR }}/preview.jpg"

                  # Get file sizes
                  size=$(stat -c%s "$output_file")
                  preview_size=$(stat -c%s "${{ env.OUTPUT_DIR }}/preview.jpg")

                  echo "size=$size" >> $GITHUB_OUTPUT
                  echo "preview_size=$preview_size" >> $GITHUB_OUTPUT
                  echo "HDR processing completed successfully. Output size: $size bytes"

            - name: Upload full resolution result
              uses: actions/upload-artifact@v4
              with:
                  name: hdr-result-${{ github.event.pull_request.number }}
                  path: ${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}
                  retention-days: 7
                  if-no-files-found: error

            - name: Create preview image for comment
              id: prepare-preview
              run: |
                  preview_file="${{ env.OUTPUT_DIR }}/preview.jpg"

                  # Create data URL for preview
                  mime_type="image/jpeg"
                  base64_preview=$(base64 -w 0 "$preview_file")
                  echo "preview_data=data:${mime_type};base64,${base64_preview}" >> $GITHUB_OUTPUT

            - name: Find existing comment
              uses: peter-evans/find-comment@v2
              id: find-comment
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-author: "github-actions[bot]"
                  body-includes: "HDR Processing Result"

            - name: Update PR with result
              uses: peter-evans/create-or-update-comment@v3
              with:
                  comment-id: ${{ steps.find-comment.outputs.comment-id }}
                  issue-number: ${{ github.event.pull_request.number }}
                  body: |
                      ## HDR Processing Result

                      Generated at: ${{ github.event.pull_request.updated_at }}

                      ### Preview
                      ![HDR Result Preview](${{ steps.prepare-preview.outputs.preview_data }})

                      ### Details
                      - Full resolution size: ${{ steps.process-hdr.outputs.size }} bytes
                      - Preview size: ${{ steps.process-hdr.outputs.preview_size }} bytes
                      - Full resolution image: [Download Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

                      <details>
                      <summary>Processing Details</summary>

                      - Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                      - Commit: ${{ github.sha }}
                      - Branch: ${{ github.head_ref }}
                      - Go Version: ${{ steps.go-setup.outputs.go-version }}
                      - Duration: ${{ job.duration }}
                      </details>
                  edit-mode: replace
